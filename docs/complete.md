# GAS 始業前点検（Googleフォーム連携）— Claude Code 向けプロンプト＆仕様

この Markdown を **CClaude Code/コード生成AI** に渡し、VS Code + clasp で実装するための詳細仕様です。最後に **そのまま貼れる最終プロンプト** を用意しています。

---

## 目的 / ゴール
- **スマホの Google フォーム入力**で「始業前点検」を実施し、**スプレッドシートに自動記録**する。
- 回答の中に **不適合が1つでもあれば**、同じスプレッドシート内に `issues` シートを自動作成して **是正依頼を1行起票**する。
- （任意）Script Properties の `NOTIFICATION_EMAIL` が設定されている場合のみ、**メール通知**を送る。
- **写真は扱わない**（本文・設問はチェックのみ）。

---

## 前提 / 環境
- Google Workspace / Google アカウントがあること。
- **Google フォーム**を作成済み（設問名は下記の仕様準拠）。
- フォームの「回答」を **スプレッドシート（回答先）へリンク**済み。
- Apps Script は **回答スプレッドシートに紐づく（コンテナバインド）プロジェクト**として実装する。
- タイムゾーン: `Asia/Tokyo`
- VS Code + **clasp** での編集/デプロイを想定（UI からの実行でも可）。

> コンテナバインド推奨理由：`onFormSubmit(e)` の **シンプルトリガーが自動発火**するため。スタンドアロンにする場合はインストール型トリガーを追加する必要がある。

---

## フォーム設問（質問タイトル）
以下のタイトルで作成してください。**タイトル名は正確に一致**させるとそのまま動きます。

- `設備ID`（記述）
- `点検者`（記述）
- `点検日`（日付）
- `潤滑油量`（選択肢：`適合` / `不適合` / `N/A`）
- `安全カバー`（選択肢：`適合` / `不適合` / `N/A`）
- `異音`（選択肢：`適合` / `不適合` / `N/A`）
- `備考`（段落）

> **拡張**：チェック項目は追加/変更可能。コード側は「メタ項目（上記の基本項目）以外」を **すべてチェック項目**として自動判定します。

---

## スプレッドシート構成
- フォーム回答リンク先：Google フォームが自動で作成。ここには **全回答**が入る。
- `issues` シート：不適合が1つでもある回答のとき、**自動作成＆1行追加**。
  - ヘッダ：`ID, 状態, 設備ID, 点検日, 点検者, 不適合項目, 備考, 起票日, 期限`
  - 新規行の仕様：
    - `ID`: `ISS-` + 8桁 UUID 断片
    - `状態`: 固定で `新規`
    - `設備ID`, `点検日`, `点検者`, `備考`: 回答から転記
    - `不適合項目`: 不適合だった設問名を `/` 区切り連結
    - `起票日`: 送信日（`yyyy-MM-dd`）
    - `期限`: `起票日 + 7日`（整数日加算。後述ユーティリティ使用）

---

## 振る舞い / ロジック
1. フォーム送信 → 回答シートへ行追加 → **`onFormSubmit(e)`** が起動。
2. `e.namedValues` から `設備ID` / `点検者` / `点検日` / `備考` を取得。
3. それ以外の設問（=チェック項目）を走査し、**「不適合/NG/×/x」** を含む回答が1つでもあれば **NG** と判定。
4. NG のとき：`issues` シートが無ければ作成し、1行起票する。
5. Script Properties に `NOTIFICATION_EMAIL` がある場合のみ、**メール通知**を送信。
6. すべて適合であれば、**何もしない**（回答自体は回答シートに残る）。

---

## 関数 / 実装仕様
- `onFormSubmit(e)`
  - 入力：フォーム送信イベント `e`。`e.namedValues` を使用。
  - メタ項目集合：`['設備ID','点検者','点検日','備考','タイムスタンプ','Timestamp']`
  - NG 判定：小文字化した回答が `"不適合"` を含む、または完全一致で `ng` / `×` / `x`。
  - issues 行の追加処理。
  - `NOTIFICATION_EMAIL` があれば `MailApp.sendEmail`。
- `setNotificationEmail(email)`
  - Script Properties に `NOTIFICATION_EMAIL` を保存するユーティリティ（初回だけ実行）。
- `addDays_(date, n)`
  - 日付に n 日加算して `Date` を返すユーティリティ。
- **コード全体要件**
  - タイムゾーン固定：`Asia/Tokyo`。日付文字列は `yyyy-MM-dd`。
  - **例外でスクリプトが落ちない**よう、最小限の null ガード。
  - **外部ライブラリ不使用**。`UrlFetchApp` なども使わない（今回はメールのみ）。
  - 日本語コメント・関数は JSDoc 風の簡易説明を付与。
  - 余計な `...` などの省略記法は使用しない（**完全なコードを1ファイル**で出力）。

---

## エラー処理・リカバリ
- `onFormSubmit(e)` で `e` や `e.namedValues` が欠落したら即 return（フォームからのイベント前提のため）。
- `issues` シート新規作成時は **一度だけヘッダ行を追加**。
- メール通知は `NOTIFICATION_EMAIL` が **設定されているときのみ** 実行。

---

## テスト / 受け入れ基準
**テスト**
1. フォームで「不適合」を1つ選んで送信 → `issues` に 1 行追加されること。
2. フォームで全て「適合」を選んで送信 → `issues` は増えないこと。
3. `setNotificationEmail('あなたのメール')` 実行後に再送信 → メールが届くこと。

**受け入れ基準**
- NG 回答で `issues` に正しい列・値が記録される。
- `期限` が `起票日 + 7日` で計算される。
- `NOTIFICATION_EMAIL` 未設定時はメール送信しない。

---

## デプロイ / 運用
- **推奨**：フォーム回答スプレッドシートの **拡張機能 → Apps Script** でプロジェクトを作成 → scriptId を控える → `clasp clone <scriptId>` で VS Code へ持ってくる。
- `clasp push` するとシート紐づけのまま反映できる。
- 初回は「実行」→権限承認が必要。
- トリガーはフォーム紐づけなら自動。動かない場合は **トリガー設定**で `onFormSubmit`（イベント：フォーム送信時）を手動追加。

---

## （任意）設問追加のしかた
- フォームに新しいチェック項目を追加（例：`リーク`）。
- コード側は **メタ項目集合に含まれない**すべての設問をチェック項目として自動判定するため、**追加のコード変更は不要**。

---

## 最終プロンプト（Claude Code にそのまま貼る）
> **指示**：以下の仕様を満たす **Google Apps Script の `Code.gs`** を 1 ファイルで出力してください。省略記号（`...`）は使わず、完全な実装のみをコードブロックで返してください。コメントは日本語で、関数ごとに簡潔な説明を入れてください。外部ライブラリは使いません。

```
要件:
- スマホの Google フォーム回答をトリガーにして、始業前点検をスプレッドシートに記録する。
- 回答の中に不適合が1つでもあれば、同スプレッドシート内に `issues` シートへ 1 行起票する（なければシート新規作成＋ヘッダ行追加）。
- メール通知は Script Properties の `NOTIFICATION_EMAIL` が設定されている場合のみ送る。
- 写真は扱わない。
- タイムゾーンは `Asia/Tokyo`、日付は `yyyy-MM-dd` 形式の文字列。

フォームの質問タイトル（メタ項目）:
- 設備ID（記述）
- 点検者（記述）
- 点検日（日付）
- 備考（段落）

チェック項目の例（選択肢）：潤滑油量 / 安全カバー / 異音 など
- 選択肢は「適合 / 不適合 / N/A」。
- コードでは、メタ項目以外の全設問をチェック項目として扱い、回答が「不適合/NG/×/x」のいずれかなら NG と判定する。

issues シートに追加する列と順序:
- ヘッダ: ID, 状態, 設備ID, 点検日, 点検者, 不適合項目, 備考, 起票日, 期限
- データ:
  - ID: 'ISS-' + 8 桁 UUID 断片
  - 状態: '新規'
  - 設備ID/点検日/点検者/備考: 回答から
  - 不適合項目: NG だった設問名を ' / ' で連結
  - 起票日: 送信日時を `yyyy-MM-dd`
  - 期限: 起票日 + 7 日

関数仕様:
- onFormSubmit(e): フォーム送信イベントから namedValues を読み、上記ロジックで issues 行を追加し、必要に応じてメール送信。
- setNotificationEmail(email): Script Properties に NOTIFICATION_EMAIL を保存（初回セットアップ用）。
- addDays_(date, n): Date に n 日を加算して返す。

実装要件:
- コンテナバインド前提のシンプルトリガー onFormSubmit を実装。
- NOTIFICATION_EMAIL が未設定ならメール送信をしない（例外を投げない）。
- issues シートが存在しなければ作成し、ヘッダ行を一度だけ追加する。
- ロジックは null/未設定に耐える（フォームから来ない値があっても落ちない）。
- すべて 1 ファイル（Code.gs）で完結。省略なし。

出力形式:
- 1つのコードブロックとして、Google Apps Script (JavaScript) の完全なコードのみを出力する。
```

---

## 付録：よくある変更点（Claude Code への追加指示例）
- 期限を 7 → 3 日にしたい：`期限 = 起票日 + 3日` に変更。
- メタ項目に `現場` を追加：メタ項目集合に `'現場'` を追加し、issues 列も `現場` 列を追加。
- NG 判定を `OK/NG/NA` に変えたい：NG 判定関数で `ans.toUpperCase() === 'NG'` のみに変更。

